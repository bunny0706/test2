<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner with Product Details</title>
</head>
<body>
    <h1>Barcode Scanner</h1>
    <div id="interactive" class="viewport"></div>
    <div id="product-details"></div>
    <h2>Scanned Products</h2>
    <ul id="scanned-products"></ul>
    <button id="complete-billing" style="display:none;" onclick="completeBilling()">Complete Billing</button>

    <script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
    <script>
        let scannedProducts = [];

        // Function to display product details
        function displayProductDetails(barcode) {
            let details = {
                "123456": {
                    name: "Soap",
                    price: "20 INR",
                    weight: "50g",
                    discount: "5%",
                    expiryDate: "2024-12-31"
                },
                "789012": {
                    name: "Shampoo",
                    price: "120 INR",
                    weight: "200ml",
                    discount: "10%",
                    expiryDate: "2024-11-30"
                }
            };

            if (details[barcode]) {
                let product = `
                    <li>
                        <p><strong>Barcode:</strong> ${barcode}</p>
                        <p><strong>Name:</strong> ${details[barcode].name}</p>
                        <p><strong>Price:</strong> ${details[barcode].price}</p>
                        <p><strong>Weight:</strong> ${details[barcode].weight}</p>
                        <p><strong>Discount:</strong> ${details[barcode].discount}</p>
                        <p><strong>Expiry Date:</strong> ${details[barcode].expiryDate}</p>
                    </li>
                `;
                document.getElementById('scanned-products').innerHTML += product;
                scannedProducts.push(details[barcode]); // Add product to scanned list
            } else {
                document.getElementById('scanned-products').innerHTML += <li>Product not found for barcode: ${barcode}</li>;
            }
        }

        // Initialize QuaggaJS
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    width: 640,
                    height: 480,
                    facingMode: "environment" // Use "user" for the front camera
                },
            },
            decoder: {
                readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "code_39_vin_reader", "upc_reader", "upc_e_reader", "codabar_reader", "i2of5_reader", "2of5_reader", "code_93_reader"] // Add more as needed
            },
        }, function(err) {
            if (err) {
                console.log(err);
                return;
            }
            console.log("Initialization finished. Ready to start scanning");
            Quagga.start(); // Start scanning immediately after initialization
        });

        // Flag to avoid multiple detections of the same barcode
        let lastDetectedCode = null;
        let detectionDebounce = false;

        // When a barcode is detected
        Quagga.onDetected(function(data) {
            if (detectionDebounce) return;

            let barcode = data.codeResult.code;
            console.log(Detected barcode: ${barcode});

            // Avoid processing the same barcode multiple times
            if (barcode !== lastDetectedCode) {
                lastDetectedCode = barcode;
                displayProductDetails(barcode); // Display the product details
            }

            detectionDebounce = true;

            // Reset detection after a short delay to scan the next barcode
            setTimeout(() => {
                detectionDebounce = false;
                lastDetectedCode = null;
            }, 1500); // Adjust the delay if necessary

            // Show the "Complete Billing" button if products have been scanned
            if (scannedProducts.length > 0) {
                document.getElementById('complete-billing').style.display = 'block';
            }
        });

        // Function to handle completion of billing
        function completeBilling() {
            alert("Billing Completed!"); // Replace with actual billing logic
            // Optionally, you could clear the scanned products list, stop Quagga, etc.
            Quagga.stop();
            document.getElementById('scanned-products').innerHTML = ''; // Clear scanned products list
            document.getElementById('complete-billing').style.display = 'none'; // Hide the button
            scannedProducts = []; // Reset the scanned products array
        }
    </script>
</body>
</html>
